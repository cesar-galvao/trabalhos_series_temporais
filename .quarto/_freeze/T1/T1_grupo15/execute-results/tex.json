{
  "hash": "06159b9046c84414e16bee9377b6201d",
  "result": {
    "markdown": "---\ntitle: \"Trabalho Prático 1\"\nsubtitle: \"Análise de Séries Temporais - 1/2023\" \nauthor:\n  - Ana Theresa Figueiredo - 18/0116088\n  - César Augusto Galvão - 19/0011572\nformat: \n  pdf:\n    toc: true\n    keep-tex: true\n    include-in-header:\n      text: |\n        \\usepackage[auth-lg]{authblk}\nexecute:\n  echo: false\n  message: false\n  warning: false\n---\n\n{{< pagebreak >}}\n\n\n\n# Introdução\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\nA série temporal escolhida foi a de número *id* correspondente a 2546. De acordo com a definição do próprio pacote, refere-se a *Large commercial banks, commercial & industrial loans*, ou seja, dados financeiros e de empréstimos industriais e comerciais. Foram realizadas medidas mensais de 1983 a 1992 e o horizonte de previsão requerido é das 18 ocorrências seguintes.\n\nO gráfico da série, com *in* e *out-sample*, é exposto a seguir.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](T1_grupo15_files/figure-pdf/plot-serie-total-1.pdf)\n:::\n:::\n\n\n# a. Decomposição da série temporal.\n\nInicia-se a decomposição utilizando STL, caso em que se utiliza uma decomposição Loess. O gráfico dos resultados da função `stl()` são expostos a seguir utilizando os argumentos `s.window` e `t.window` iguais a sete. Esta configuração de argumentos foi escolhida após algumas iterações -- balizada também por recomendações de Cleveland *et al.* (1990) -- buscando, entre outros fatores, um comportamento adequado dos resíduos do modelo.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](T1_grupo15_files/figure-pdf/STL-1.pdf)\n:::\n:::\n\n\nDe fato, observa-se uma tendência crescente até 1990, além de parecer haver também uma sazonalidade anual. Esta apresenta alguns picos mais intensos no começo dos ciclos periódicos e menos intensos na segunda metade da série.\n\nAlém disso, o termo aleatório parece estável a menos de um pico em 1987, característica que orientou a escolha dos valores para `t.window` e `s.window`. \n\nExperimenta-se também a decomposição via MSTL, procurando uma sazonalidade múltipla, sugerida pelos picos nos inícios das ondas sazonais. Após algumas iterações, optou-se pelo período bimestral, complementarmente ao período mensal original da série. Os mesmos valores para os argumentos de janela foram utilizados.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](T1_grupo15_files/figure-pdf/unnamed-chunk-1-1.pdf)\n:::\n:::\n\n\nDe fato, conseguiu-se remover o pico inicial da sazonalidade simples. No entanto, nota-se uma variação grande nas amplitudes sazonais, assim como homocedasticidade do resíduo.\n\nOpta-se finalmente pela decomposição STL, com sazonalidade simples.\n\n# b. Escolha um modelo ARIMA\n\n-   O modelo selecionado deve ser baseado no que você visualizou na decomposição, testes estatísticos, gráficos ACF, gráficos PACF, critérios de parcimonia e resíduos;\n-   Detalhe todo o procedimento da escolha do modelo;\n-   Nao pode usar AutoArima\n-   Tem q fazer o algorito mostrado em sala.\n\nPara selecionar o modelo ARIMA, iniciamos pela identificação das diferenciações sazonais e não sazonais utilizando as funções `nsdiffs()` e `ndiffs()`, respectivamente, do pacote `forecast`. Dessa forma, para um modelo $\\text{SARIMA}(p,d,q)\\times(P,D,Q)_{12}$ ou $\\text{SARMA}(P,Q)_{12}$, obtemos os valores de $D$ e $d$.\n\n\n::: {.cell}\n\n:::\n\n\nIsto feito, sabemos que o modelo é pelo menos $(p,2,q)\\times(P,0,Q)_{12}$.\n\n## Estacionariedade da série\n\nAntes de prosseguir, avalia-se a estacionariedade da série. Para isso, utiliza-se o teste KPSS (Kwiatkowski *et al.*, 1992). As hipóteses do teste são:\n\n$$\n\\begin{aligned}\n  &H_0: \\text{o processo é estacionário} \\\\\n  &H_1: \\text{o processo possui raiz unitária}\n\\end{aligned}\n$$\nOs resultados do teste são exibidos na tabela a seguir, sugerindo não rejeitar a hipótese de estacionariedade.\n\n\n::: {.cell}\n::: {.cell-output-display}\n\\begin{longtable}{ccc}\n\\toprule\nEstatística de teste & p-valor & Método\\\\\n\\midrule\n\\endfirsthead\n\\multicolumn{3}{@{}l}{\\textit{(continued)}}\\\\\n\\toprule\nEstatística de teste & p-valor & Método\\\\\n\\midrule\n\\endhead\n\n\\endfoot\n\\bottomrule\n\\endlastfoot\n\\cellcolor{gray!15}{0.0244372} & \\cellcolor{gray!15}{0.1} & \\cellcolor{gray!15}{KPSS Test for Level Stationarity}\\\\*\n\\end{longtable}\n:::\n:::\n\n\n\n\n## Análise gráfica FAC e FACP\n\nA seguir são expostos três gráficos para a série diferenciada em $\\nabla^2x_t$: a série original com duas diferenciações simples (portanto estacionária), sua Função de Autocorrelação - FAC (*ACF*) e a Função de Autocorrelação Parcial - FACP (*Partial ACF*).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](T1_grupo15_files/figure-pdf/FAC-FACP-1.pdf)\n:::\n:::\n\n\nNota-se um decaimento amortecido no gráfico FAC e poucas correlações fora da banda apenas até Lag 1 do FACP. As autocorrelações parciais, no entanto, também decaem de forma amortecida para zero sem quebras. Este comportamento indica candidatos a modelos ARIMA ou SARMA.\n\n## Análise iterativa\n\nNa falta de comportamentos claros indicando os demais coeficientes, recorre-se a uma varredura para selecionar o modelo mais parcimonioso utilizando AICc como critério.\n\nConforme a saída a seguir, verifica-se uma boa configuração sendo $\\text{SARMA}(0,2,1)\\times(1,0,0)$\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"p = 0, q = 1, P = 1, Q = 0, AICc = 1313.1422\"\n[2] \"p = 0, q = 1, P = 0, Q = 1, AICc = 1313.8014\"\n[3] \"p = 0, q = 1, P = 0, Q = 0, AICc = 1318.3233\"\n[4] \"p = 0, q = 0, P = 1, Q = 0, AICc = 1380.2924\"\n[5] \"p = 0, q = 0, P = 0, Q = 1, AICc = 1380.984\" \n[6] \"p = 0, q = 0, P = 0, Q = 0, AICc = 1387.0622\"\n```\n:::\n:::\n\n\nFinalmente, ajusta-se o modelo conforme as especificações e obtém-se os seguintes coeficientes:\n\n\n::: {.cell}\n::: {.cell-output-display}\n\\begin{longtable}{cc}\n\\toprule\nCoeficiente & Valor\\\\\n\\midrule\n\\endfirsthead\n\\multicolumn{2}{@{}l}{\\textit{(continued)}}\\\\\n\\toprule\nCoeficiente & Valor\\\\\n\\midrule\n\\endhead\n\n\\endfoot\n\\bottomrule\n\\endlastfoot\n\\cellcolor{gray!15}{ma1} & \\cellcolor{gray!15}{-0.8394}\\\\\nsar1 & 0.2545\\\\*\n\\end{longtable}\n:::\n:::\n\n\n\n\n# c. Análise de resíduos do modelo selecionado.\n\nPara avaliar a qualidade do modelo, verifica-se as seguintes suposições sobre $\\{\\varepsilon_t\\}$:\n\n- Média zero,\n- Variância constante,\n- Autocorrelação nula,\n- Normalidade.\n\nVerifica-se inicialmente a série dos resíduos sem a incialização com zeros. Graficamente, pode-se dizer que tem média igual a zero. De fato, a média calculada dos resíduos corresponde a -9.495, o que é muito próximo de zero considerando a ordem de grandeza de muitos valores dos resíduos. Além disso, a variância parece ser constante, a menos do pico no meio da série.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](T1_grupo15_files/figure-pdf/dist-residuos-1.pdf)\n:::\n:::\n\nO Q-Q Plot a seguir aponta uma proximidade não ideal em relação à distribuição normal com uma caudal mais pesada à esquerda e um ponto extremo à direita. Além disso, o ACF possui uma quebra na banda de confiança, mas mantém as demais autocorrelações dentro dos limites.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](T1_grupo15_files/figure-pdf/unnamed-chunk-3-1.pdf)\n:::\n:::\n\nPor fim, verifica-se utilizando testes de hipótese estacionariedade ($H_0:$ o processo é estacionário), independência ($H_0: \\rho(1) = \\rho(2), = \\dots = \\rho(m) = 0$) e normalidade ($H_0:$ não se rejeita normalidade) dos resíduos do modelo.\n\nInfere-se pelos testes que se trata de uma série estacionária, com autocorrelações todas iguais a zero, porém não normal. Isso provavelmente ocorre por causa de um peso maior na cauda esquerda e por causa da presença de alguns valores extremos.\n\n\n::: {.cell}\n::: {.cell-output-display}\n\\begin{longtable}{ccc}\n\\toprule\nEstatística de teste & p-valor & Método\\\\\n\\midrule\n\\endfirsthead\n\\multicolumn{3}{@{}l}{\\textit{(continued)}}\\\\\n\\toprule\nEstatística de teste & p-valor & Método\\\\\n\\midrule\n\\endhead\n\n\\endfoot\n\\bottomrule\n\\endlastfoot\n\\cellcolor{gray!15}{0.2061} & \\cellcolor{gray!15}{0.1000} & \\cellcolor{gray!15}{KPSS Test for Level Stationarity}\\\\\n15.7901 & 0.7296 & Box-Ljung test\\\\\n\\cellcolor{gray!15}{0.8363} & \\cellcolor{gray!15}{0.0000} & \\cellcolor{gray!15}{Shapiro-Wilk normality test}\\\\*\n\\end{longtable}\n:::\n:::\n\n\n\n# d. Apresentação do modelo selecionado\n\nO modelo selecionado é, conforme ja apresentado, $\\text{SARMA}(0,2,1)\\times(1,0,0)_{12}$. Em forma polinomial temos:\n\n$$\n\\begin{aligned}\n  \\Phi_P(B^s)\\nabla^2 x_t =& \\, \\Theta(B)\\varepsilon_t \\\\\n  \\Phi_1(B) \\nabla^2 x_t =& \\, \\Theta_1(B)\\varepsilon_t\\\\\n  (1-\\phi_1 B)(x_t - 2x_{t-1} + x_{t-2}) =& \\, (1+\\theta_1 B)\\varepsilon_t \\\\\n  x_t - 2x_{t-1} + x_{t-2} -\\phi_1x_{t-1}-2\\phi_1x_{t-2} -\\phi_1x_{t-3}  =& \\, \\varepsilon_t  + \\theta_1 \\varepsilon_{t-1} \\\\\n  x_t  =& \\, \\varepsilon_t  + \\theta_1 \\varepsilon_{t-1} + 2x_{t-1} - x_{t-2} +\\phi_1x_{t-1}+2\\phi_1x_{t-2} +\\phi_1x_{t-3}\n\\end{aligned}\n$$\n\nFinalmente, obtemos\n\n$$\n\\begin{aligned}\nx_t  &= \\, \\varepsilon_t  -0.839 \\, \\varepsilon_{t-1} + 2x_{t-1} - x_{t-2} +0.255 \\, x_{t-1} + 0.51 \\, x_{t-2} +0.255 x_{t-3}\\\\\n &= \\, \\varepsilon_t  -0.839 \\, \\varepsilon_{t-1} + 2.255x_{t-1} - 0.49 \\, x_{t-2}+0.255 x_{t-3}\n \\end{aligned}\n$$\n\n# Comparação auto.arima()\n\nPor fim, compara-se o modelo com a saída do modelo sugerido pela função automatizada. De fato, são proximos e o modelo é o mesmo que o selecionado manualmente.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\nSeries: serie$x \nARIMA(0,2,1)(1,0,0)[12] \n\nCoefficients:\n          ma1    sar1\n      -0.9385  0.2455\ns.e.   0.0404  0.0891\n\nsigma^2 = 5547:  log likelihood = -653.46\nAIC=1312.92   AICc=1313.14   BIC=1321.13\n```\n:::\n:::\n\n\n\n\n# Apêndice\n\nTodo o projeto de composição deste documento pode ser encontrado aqui: https://github.com/cesar-galvao/trabalhos_series\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(Mcomp, tidyverse, forecast, fpp2, xts, tseries, tidymodels)\n\ndata(M3) #carrega os dados\nid <- 2546 #série temporal escolhida\n\nserie <- M3[[id]]\n\ndados <- serie$x\n\nplot(serie, main = \"Série Temporal M3-2546\")\n\nserie$x %>% \n  stl(s.window = 7, t.window = 7) %>%\n  plot(main = \"Decomposição STL (LOESS)\")\n\n#sazonalidade diaria e semanal\nmsts(serie$x, seasonal.periods = c(12, 6))%>%\n#janela de ajuste 'Cleveland et al (1990)'\n  mstl(., s.window = 7, t.window = 7) %>% plot(main = \"Decomposição MSTL\")\n\nd <- ndiffs(serie$x)\n\nD <- serie$x %>% diff() %>% nsdiffs()\n\n#aplica 2 diferenciacoes\nserie_d <- serie$x %>% diff(differences = 2)\n\nkpss.test(serie_d)\n\npar(mfrow = c(1, 3))\nplot(serie_d)\nacf(serie_d, lag.max = 12*7)\npacf(serie_d, lag.max = 12*7)\n\nparcim <- character()\n\nmelhor_AICc <- Inf\nfor(p in 0:2){\n  for(q in 0:2){\n    for(P in 0:1){\n      for(Q in 0:1){\n        fit <- Arima(serie$x, order = c(p,2,q), seasonal = c(P, 0, Q))\n        if(fit$aicc < melhor_AICc){\n          melhor_AICc <- fit$aicc\n          parcim <- c(paste0(\"p = \",p,\", q = \", q, \", P = \", P, \", Q = \", Q,\n                             \", AICc = \", round(fit$aicc,4)),parcim)\n        }\n      }\n    }\n  }\n}\n\n\n\nparcim\n\n\nfit <- arima(serie$x, order = c(0,2,1), seasonal = c(1,0,0), method = \"CSS\")\n\nfit$coef %>% tidy()\n\n\npar(mfrow=c(1,2))\nE <- fit$residuals %>% window(start=c(1984,3))\nE1 <- fit$residuals\nplot(E1)\nplot(E, main = \"Processo dos resíduos\")\n\npar(mfrow=c(1,3))\nplot(E)\nqqnorm(E)\nqqline(E)\nacf(E, lag.max=12*5)\n\n\nbind_rows(\n  tseries::kpss.test(E) %>% tidy() %>% select(-parameter),\n  Box.test(E, lag = 20, type = \"Ljung-Box\")%>% tidy() %>% select(-parameter)\n  \n  auto.arima(serie$x, d = 2, D = 0)\n```\n:::\n",
    "supporting": [
      "T1_grupo15_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "\\usepackage{booktabs}\r\n\\usepackage{longtable}\r\n\\usepackage{array}\r\n\\usepackage{multirow}\r\n\\usepackage{wrapfig}\r\n\\usepackage{float}\r\n\\usepackage{colortbl}\r\n\\usepackage{pdflscape}\r\n\\usepackage{tabu}\r\n\\usepackage{threeparttable}\r\n\\usepackage{threeparttablex}\r\n\\usepackage[normalem]{ulem}\r\n\\usepackage{makecell}\r\n\\usepackage{xcolor}\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}